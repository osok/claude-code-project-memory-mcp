# Claude Memory MCP - Database Infrastructure
# =============================================
#
# This docker-compose file provides the database infrastructure for the Claude
# Memory MCP server. The MCP server itself runs locally (not in Docker) and
# connects to these databases.
#
# Usage:
#   cd docker
#   docker-compose up -d
#
# REQ-MEM-002-FN-040: Database-only docker-compose
# REQ-MEM-002-FN-041: Named volumes for persistence
# REQ-MEM-002-FN-042: Ports bound to localhost only
# REQ-MEM-002-CON-001: MCP server NOT in Docker

version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:v1.15.0
    container_name: claude-memory-qdrant
    restart: unless-stopped
    ports:
      # Bound to localhost only for security (REQ-MEM-002-FN-042)
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      # Named volume for data persistence (REQ-MEM-002-FN-041)
      - claude-memory-qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  neo4j:
    image: neo4j:5.15-community
    container_name: claude-memory-neo4j
    restart: unless-stopped
    ports:
      # Bound to localhost only for security (REQ-MEM-002-FN-042)
      - "127.0.0.1:7474:7474"
      - "127.0.0.1:7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-changeme}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      # Named volumes for data persistence (REQ-MEM-002-FN-041)
      - claude-memory-neo4j-data:/data
      - claude-memory-neo4j-logs:/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# Named volumes with explicit names (REQ-MEM-002-FN-041)
volumes:
  claude-memory-qdrant-data:
    name: claude-memory-qdrant-data
  claude-memory-neo4j-data:
    name: claude-memory-neo4j-data
  claude-memory-neo4j-logs:
    name: claude-memory-neo4j-logs
